#!/bin/bash

export DEBIAN_FRONTEND=noninteractive
HOST_DIR=/vagrant

### PHP install ###################################################

## Prerequisites

apt-get update

apt-get -y -qq install libxml2-dev
apt-get -y -qq install libssl-dev libsslcommon2-dev
apt-get -y -qq install autoconf

# Fetch it

mkdir php-install
cd php-install

PHP_VERSION="php-5.6.11"
PHP_INSTALL_DIR="/var/lib/$PHP_VERSION"
PHP_TAR="$PHP_VERSION.tar.xz"
PHP_DL="http://uk1.php.net/get/$PHP_VERSION.tar.xz/from/this/mirror"
PHP_INI_FILE=/etc/php.ini
PHP_INI_DIR=/etc/php.d

mkdir $PHP_INSTALL_DIR
mkdir $PHP_INI_DIR

wget -nv $PHP_DL -O $PHP_TAR

tar -xf $PHP_TAR

./$PHP_VERSION/configure --prefix=$PHP_INSTALL_DIR --with-openssl --with-libdir=/lib/x86_64-linux-gnu --with-config-file-path=$PHP_INI_FILE --with-config-file-scan-dir=/etc/php.d --enable-zip --with-pdo-mysql --with-curl
make
make install

cp ./$PHP_VERSION/php.ini-development $PHP_INI_FILE
ln -s $PHP_INSTALL_DIR/bin/php /usr/bin/php
ln -s $PHP_INSTALL_DIR/bin/pecl /usr/bin/pecl
ln -s $PHP_INSTALL_DIR/bin/phpize /usr/bin/phpize
cd ..

### Extensions
# libevent
apt-get -y -qq install libevent-dev
yes '' | pecl install libevent-beta
echo "extension=libevent.so" > /etc/php.d/libevent.ini

# libev
yes '' | pecl install ev
echo "extension=ev.so" > /etc/php.d/ev.ini

# xdebug
yes '' | pecl install xdebug
echo "zend_extension=$PHP_INSTALL_DIR/lib/php/extensions/no-debug-non-zts-20131226/xdebug.so" > /etc/php.d/xdebug.ini


### MySQL install ###################################################

mkdir mysql-install
cd mysql-install

MYSQL_ROOT_PASSWORD=E28LpCrfJwMJwCS7
MYSQL_PACKAGE=mysql-server-5.6

wget -nv http://dev.mysql.com/get/mysql-apt-config_0.3.5-1ubuntu14.04_all.deb
dpkg -i mysql-apt-config_0.3.5-1ubuntu14.04_all.deb

apt-get -qq update
echo "$MYSQL_PACKAGE mysql-server/root_password password $MYSQL_ROOT_PASSWORD" | debconf-set-selections
echo "$MYSQL_PACKAGE mysql-server/root_password_again password $MYSQL_ROOT_PASSWORD" | debconf-set-selections
apt-get -qq install $MYSQL_PACKAGE

mysql -u root --password=$MYSQL_ROOT_PASSWORD < $HOST_DIR/mysql/chappy_init.sql

cd ..

### Composer ###################################################

COMPOSER_DIR=/var/lib/composer
curl -sS http://getcomposer.org/installer | php
mkdir $COMPOSER_DIR
mv composer.phar $COMPOSER_DIR
ln -s $COMPOSER_DIR/composer.phar /usr/bin/composer

### Git ###################################################
apt-get -y -qq install git



rm -rf *-install